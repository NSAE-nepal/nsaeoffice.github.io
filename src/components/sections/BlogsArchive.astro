---
import { getCollection } from "astro:content";
import ClickableCard from "../astro/Card/ClickableCard.astro";
import BlogFeaturedCard from "../astro/Card/BlogFeaturedCard.astro";
import BlogCard from "../astro/Card/BlogCard.astro";
import { Image } from "astro:assets";
import Badge from "../astro/Badge.astro";
import ArrowRight from "@tabler/icons/outline/arrow-right.svg";

const allPublishedPosts = (
  await getCollection("posts", ({ data }) => {
    return (
      (import.meta.env.MODE !== "production" || data.draft === false) &&
      data.type === "blog"
    );
  })
).sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());

const featuredPosts = allPublishedPosts.filter(({ data }) => data.featured);
const nonFeaturedPosts = allPublishedPosts.filter(({ data }) => !data.featured);

let mainFeature = null;
let sideListPosts = [];

if (featuredPosts.length > 0) {
  mainFeature = featuredPosts[0];
  const remainingFeatured = featuredPosts.slice(1);
  const combinedPool = [...remainingFeatured, ...nonFeaturedPosts];
  sideListPosts = combinedPool.slice(0, 3);
} else {
  mainFeature = null;
  sideListPosts = nonFeaturedPosts.slice(0, 3);
}
---

{
  allPublishedPosts.length > 0 && (
    <section class="blog-section pt-24 md:pt-32">
      <div class="flex flex-col md:flex-row justify-between items-start md:items-end mb-12 gap-6">
        <div class="anim-blog-header space-y-4 opacity-0 translate-y-8">
          <Badge
            variant="secondary"
            size="sm"
            class="font-mono text-xs uppercase tracking-widest"
          >
            The Journal
          </Badge>
          <h2 class="font-sans text-4xl md:text-5xl font-medium tracking-tighter">
            Latest Updates
          </h2>
        </div>

        <a
          href="/blog/page/1"
          class="anim-blog-header group flex items-center gap-2 font-mono text-xs uppercase tracking-widest text-muted-foreground hover:text-primary transition-colors opacity-0 translate-y-8"
        >
          View All Archives
          <ArrowRight class="size-4 transition-transform group-hover:translate-x-1" />
        </a>
      </div>
      <div class="grid grid-cols-2 gap-4">
        {mainFeature && (
          <div class="anim-blog-card col-span-2 lg:col-span-1 bg-secondary p-4 rounded-2xl border border-border/50 opacity-0 translate-y-12">
            <ClickableCard href={`/${mainFeature.id}/`}>
              <BlogFeaturedCard class="md:grid-cols-1" {...mainFeature} />
            </ClickableCard>
          </div>
        )}

        <div
          class:list={[
            "anim-blog-card opacity-0 translate-y-12",
            "col-span-2",
            mainFeature ? "lg:col-span-1" : "grid grid-cols-1  gap-4",
          ]}
        >
          {sideListPosts.map((post) => (
            <ClickableCard
              class="group relative border-b border-border last:border-b-0 hover:bg-secondary transition-colors duration-300 overflow-hidden"
              href={`/${post.id}/`}
            >
              <BlogCard {...post} />
              {post.data.heroImage && (
                <Image
                  inferSize
                  class={
                    "absolute top-0 right-0 h-full w-1/4 object-cover z-0 hidden group-hover:block opacity-40 grayscale group-hover:grayscale-0 transition-opacity duration-500"
                  }
                  src={post.data.heroImage}
                  alt={post.data.heroImageAlt ?? ""}
                />
              )}
            </ClickableCard>
          ))}
        </div>
      </div>
    </section>
  )
}

<script>
  import gsap from "gsap";
  import { ScrollTrigger } from "gsap/ScrollTrigger";

  if (typeof window !== "undefined") {
    gsap.registerPlugin(ScrollTrigger);

    const tl = gsap.timeline({
      scrollTrigger: {
        trigger: ".blog-section",
        start: "top 75%",
      },
    });

    tl.to(".anim-blog-header", {
      y: 0,
      opacity: 1,
      duration: 0.8,
      stagger: 0.1,
      ease: "power3.out",
    }).to(
      ".anim-blog-card",
      {
        y: 0,
        opacity: 1,
        duration: 0.8,
        stagger: 0.2,
        ease: "power2.out",
      },
      "-=0.4"
    );
  }
</script>
